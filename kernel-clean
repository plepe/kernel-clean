#!/bin/sh

# Check for current installed kernel
CURRENT="linux-image-`uname -r`"
echo "Current running kernel: $CURRENT"

# Get list of installed kernels, sort by version ascending
IMAGES=`dpkg -l "linux-image-*" | grep -E '^ii[[:space:]]+linux-image-[\.[:digit:]]+' | awk '{print $2}' | sort -V`

# Get newest installed kernel from list of installed kernels
NEWEST=`echo "$IMAGES" | tail -n1`
echo "Newest installed kernel: $NEWEST"

# Print version of newest installed generic kernel
GENERIC=`dpkg -l linux-image-generic | grep -E '^ii' | awk '{print $3}' `
if [ -n "$GENERIC" ]; then
	echo "Newest installed generic kernel version: $GENERIC"
fi

# Remove all kernels but newest and current
TOREMOVE=`echo "$IMAGES" | head -n-1 | grep -v $CURRENT`

# Also remove linux headers
HEADERS=`echo "$TOREMOVE" | sed 's/linux-image-\(.*\)-\(.*\)/linux-headers-\1/'`

# Check which header files are installed
N=""
for i in $HEADERS ; do
  if [ "`dpkg -l $i 2>/dev/null | grep -E \"^ii  $i\"`" != "" ] ; then
    N="$N $i"
  fi
done
HEADERS=$N

# List all kernels and headers which are to be removed
echo "To remove:"
for i in $TOREMOVE $HEADERS ; do
  echo "  $i"
done

# Check for additional parameters to apt-get
if [ "$1" = "-y" ]
then
	ARGS="$ARGS -y"
fi

# Remove kernels
apt-get $ARGS purge $TOREMOVE $HEADERS
